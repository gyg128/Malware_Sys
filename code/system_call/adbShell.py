import subprocess
import os
import threading

apks = os.listdir('apk')
emulator = 'emulator-5554'
pID = '1022'

def strace(apkName):
    print('start strace')
    straceShell = subprocess.Popen('adb -s ' + emulator + ' shell', shell = True, stdin = subprocess.PIPE)
    straceShell.stdin.write('su\n'.encode('utf-8'))
    straceShell.stdin.write(('timeout 7 strace -o /data/strace/' + apkName + '.txt -e trace=all -f -p ' + pID + '\n').encode('utf-8'))
    straceShell.stdin.write('exit\n'.encode('utf-8'))  #重点，一定要执行exit

for apk in apks:
    apkName = apk[ : apk.index('.apk')]
    print('apk install ' + apkName)
    subprocess.call('adb -s ' + emulator + ' install apk/' + apk, shell = True)
    print('get package name')
    subprocess.call('aapt dump badging apk/' + apk + ' > aapt/' + apkName + '.txt', shell = True)
    aaptFile = open('aapt/' + apkName + '.txt', 'r', encoding='UTF-8')
    aaptLine = aaptFile.readline()
    aaptFile.close()
    packageName = aaptLine[aaptLine.index('\'') + 1 : aaptLine.index('\'', aaptLine.index('\'') + 1)]
    print(packageName)
    threading.Thread(target=strace, args=(apkName,)).start()
    print('start monkey')
    monkeyShell = subprocess.Popen('adb -s ' + emulator + ' shell', shell = True, stdin = subprocess.PIPE)
    monkeyShell.stdin.write('sleep 2\n'.encode('utf-8'))
    monkeyShell.stdin.write(('timeout 5 monkey --ignore-crashes --ignore-timeouts --ignore-security-exceptions -p ' + packageName + ' 2000\n').encode('utf-8'))
    monkeyShell.stdin.write(('pm uninstall ' + packageName +'\n').encode('utf-8'))
    monkeyShell.stdin.write('exit\n'.encode('utf-8'))
    monkeyShell.communicate()   #否则管道会卡住
    print('start pull')
    subprocess.call('adb -s ' + emulator + ' pull /data/strace/' + apkName + '.txt strace/' + apkName + '.txt', shell = True)
    subprocess.call('adb -s ' + emulator + ' shell rm /data/strace/' + apkName + '.txt', shell = True)