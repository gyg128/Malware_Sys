# -*- coding: utf-8 -*-
import os
import zipfile
import re

def apk2dext(filepath, filename):
    '''
        将apk中的dex文件提取出来
        :param filepath: apk文件路径
        :param filename: apk文件名
    '''
    # 直接用zipfile.ZipFile处理.apk文件
    file = filepath+'\\'+filename+".apk"
    apkfile = zipfile.ZipFile(file, 'r')
    if os.path.isdir(filepath+'\dex') == False:
        os.mkdir(filepath+'\dex')
    # 将apk内所有.dex文件都生成在'dex/'路径下
    for tempfile in apkfile.namelist():  # 遍历apk包内的所有文件名
        if tempfile.endswith('.dex'):
            dexfilename = ''.join(filename + '.dex')  # 随机16位字符串文件名
            f = open(filepath+'\dex\\' + dexfilename, 'wb+')
            f.write(apkfile.read(tempfile))

def dex2txt(filepath, filename):
    '''
        将dex文件反编译为java文件
        :param filepath: dex文件路径
        :param filename: dex文件名
    '''
    if os.path.isdir(filepath + '\\txt') == False:
        os.mkdir(filepath + '\\txt')
    dex_to_txt = "D:\\MF1\\dexdump.exe -d "+filepath+"\\"+filename+".dex >"+filepath+"\\txt\\"+filename+'.txt'
    print(dex_to_txt)
    os.system(dex_to_txt)

def extract_api(filepath, filename):
    '''
        将dex文件中的api提取出来
        :param filepath: txt文件路径
        :param filename: txt文件名
    '''
    file = open(filepath+'\\'+filename, 'rb')
    for line in file.readlines():
        line = line.decode("ISO-8859-1")
        match = re.match(r"^[0-9|a-zA-Z]{6}[:]\s([0-9|a-zA-Z]{4}\s){3}", line)
        if match != None:
            line_d = line.replace(";.","->")
            start = line_d.find('L')
            if start!=-1:
                end = line_d.find(':', start)
                api = line_d[start+1: end]
                if os.path.isdir(filepath + '\\api') == False:
                    os.mkdir(filepath + '\\api')
                file_new = open(filepath+'api\\'+filename,mode="a+")
                file_new.writelines(api+"()\n")

apkpath = "D:\MF1\Benign_2017"  # apk文件位置
apkdir = os.listdir(apkpath)

for apkfile in apkdir:
    if ".apk" in apkfile:
        filename = apkfile[:-4]
        apk2dext(apkpath, filename)  # apk文件中提取出dex文件
        dexpath = apkpath+"\dex"
        dex2txt(dexpath, filename)  # 将dex文件反编译为java文件保存到txt文件中
        txtpath = dexpath+'\\txt'
        extract_api(txtpath+"\\", filename+'.txt')  # 提取api
